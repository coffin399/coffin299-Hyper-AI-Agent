name: Build Android APK

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'android/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'android/**'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release build'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml==6.0.1
        pip install -r requirements.txt
        
    - name: Setup React Native
      run: |
        cd mobile
        npm install
        npm install -g react-native-cli
        
    - name: Create Android project structure
      run: |
        mkdir -p android/app/src/main/java/com/hyperagent
        mkdir -p android/app/src/main/res/values
        mkdir -p android/app/src/main/res/mipmap-hdpi
        mkdir -p android/app/src/main/res/mipmap-mdpi
        mkdir -p android/app/src/main/res/mipmap-xhdpi
        mkdir -p android/app/src/main/res/mipmap-xxhdpi
        mkdir -p android/app/src/main/res/mipmap-xxxhdpi
        
    - name: Generate Android files
      run: |
        # Generate package.json for React Native
        cat > package.json << 'EOF'
        {
          "name": "hyper-agent",
          "version": "1.0.0",
          "private": true,
          "scripts": {
            "android": "react-native run-android",
            "start": "react-native start",
            "test": "jest",
            "lint": "eslint . --ext .js,.jsx,.ts,.tsx"
          },
          "dependencies": {
            "react": "18.2.0",
            "react-native": "0.72.6",
            "react-native-vector-icons": "^10.0.0",
            "@react-navigation/native": "^6.1.9",
            "@react-navigation/stack": "^6.3.20",
            "@react-navigation/bottom-tabs": "^6.5.11",
            "react-native-screens": "^3.27.0",
            "react-native-safe-area-context": "^4.7.4",
            "react-native-paper": "^5.11.1",
            "react-native-linear-gradient": "^2.8.3"
          },
          "devDependencies": {
            "@babel/core": "^7.20.0",
            "@babel/preset-env": "^7.20.0",
            "@babel/runtime": "^7.20.0",
            "@react-native/eslint-config": "^0.72.2",
            "@react-native/metro-config": "^0.72.11",
            "@tsconfig/react-native": "^3.0.0",
            "@types/react": "^18.0.24",
            "@types/react-test-renderer": "^18.0.0",
            "babel-jest": "^29.2.1",
            "eslint": "^8.19.0",
            "jest": "^29.2.1",
            "metro-react-native-babel-preset": "0.76.8",
            "prettier": "^2.4.1",
            "react-test-renderer": "18.2.0",
            "typescript": "4.8.4"
          }
        }
        EOF
        
    - name: Create Android Gradle files
      run: |
        # settings.gradle
        cat > android/settings.gradle << 'EOF'
        rootProject.name = 'HyperAgent'
        apply from: file("../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesSettingsGradle(settings)
        include ':app'
        includeBuild('../node_modules/react-native-gradle-plugin')
        EOF
        
        # build.gradle (project level)
        cat > android/build.gradle << 'EOF'
        buildscript {
            ext {
                buildToolsVersion = "33.0.0"
                minSdkVersion = 21
                compileSdkVersion = 33
                targetSdkVersion = 33
                ndkVersion = "23.1.7779620"
            }
            dependencies {
                classpath("com.android.tools.build:gradle:7.3.1")
                classpath("com.facebook.react:react-native-gradle-plugin")
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
            }
        }
        EOF
        
        # app/build.gradle
        cat > android/app/build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "com.facebook.react"
        
        android {
            ndkVersion rootProject.ext.ndkVersion
            compileSdkVersion rootProject.ext.compileSdkVersion
            
            namespace "com.hyperagent"
            defaultConfig {
                applicationId "com.hyperagent"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0"
            }
            
            signingConfigs {
                debug {
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
                release {
                    if (project.hasProperty('MYAPP_UPLOAD_STORE_FILE')) {
                        storeFile file(MYAPP_UPLOAD_STORE_FILE)
                        storePassword MYAPP_UPLOAD_STORE_PASSWORD
                        keyAlias MYAPP_UPLOAD_KEY_ALIAS
                        keyPassword MYAPP_UPLOAD_KEY_PASSWORD
                    }
                }
            }
            
            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    signingConfig signingConfigs.release
                    minifyEnabled enableProguardInReleaseBuilds
                    proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                }
            }
        }
        
        dependencies {
            implementation fileTree(dir: "libs", include: ["*.jar"])
            implementation "com.facebook.react:react-native:+"
            implementation "androidx.swiperefreshlayout:swiperefreshlayout:1.0.0"
            debugImplementation("com.facebook.flipper:flipper:${FLIPPER_VERSION}") {
                exclude group:'com.facebook.fbjni'
            }
            debugImplementation("com.facebook.flipper:flipper-network-plugin:${FLIPPER_VERSION}") {
                exclude group:'com.facebook.flipper'
                exclude group:'com.squareup.okhttp3', module:'okhttp'
            }
            debugImplementation("com.facebook.flipper:flipper-fresco-plugin:${FLIPPER_VERSION}") {
                exclude group:'com.facebook.flipper'
            }
        }
        
        apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
        EOF
        
        # gradle.properties
        cat > android/gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
        android.useAndroidX=true
        android.enableJetifier=true
        newArchEnabled=false
        hermesEnabled=true
        FLIPPER_VERSION=0.125.0
        EOF
        
        # gradle wrapper
        cat > android/gradlew << 'EOF'
        #!/bin/bash
        
        DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
        APP_NAME="Gradle"
        APP_BASE_NAME=`basename "$0"`
        
        CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
        
        if [ "$OSTYPE" = "cygwin" ] || [ "$OSTYPE" = "msys" ] || [ "$OSTYPE" = "win32" ] ; then
            CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
            JAVACMD=`cygpath --unix "$JAVACMD"`
        fi
        
        exec "$JAVACMD" $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$@"
        EOF
        
        chmod +x android/gradlew
        
    - name: Create Android Manifest
      run: |
        cat > android/app/src/main/AndroidManifest.xml << 'EOF'
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.hyperagent">
            
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
            <uses-permission android:name="android.permission.CAMERA" />
            <uses-permission android:name="android.permission.RECORD_AUDIO" />
            
            <application
              android:name=".MainApplication"
              android:label="@string/app_name"
              android:icon="@mipmap/ic_launcher"
              android:roundIcon="@mipmap/ic_launcher_round"
              android:allowBackup="false"
              android:theme="@style/AppTheme"
              android:usesCleartextTraffic="true">
              <activity
                android:name=".MainActivity"
                android:label="@string/app_name"
                android:configChanges="keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode"
                android:launchMode="singleTask"
                android:windowSoftInputMode="adjustResize"
                android:exported="true">
                <intent-filter>
                    <action android:name="android.intent.action.MAIN" />
                    <category android:name="android.intent.category.LAUNCHER" />
                </intent-filter>
              </activity>
            </application>
        </manifest>
        EOF
        
    - name: Create Android resources
      run: |
        # strings.xml
        cat > android/app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">Hyper AI Agent</string>
        </resources>
        EOF
        
        # styles.xml
        cat > android/app/src/main/res/values/styles.xml << 'EOF'
        <resources>
            <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
                <item name="android:editTextBackground">@drawable/rn_edit_text_material</item>
            </style>
        </resources>
        EOF
        
        # colors.xml
        cat > android/app/src/main/res/values/colors.xml << 'EOF'
        <resources>
            <color name="primary">#0099ff</color>
            <color name="primary_dark">#0077cc</color>
            <color name="accent">#00ff99</color>
        </resources>
        EOF
        
    - name: Create Java files
      run: |
        # MainApplication.java
        cat > android/app/src/main/java/com/hyperagent/MainApplication.java << 'EOF'
        package com.hyperagent;
        
        import android.app.Application;
        import com.facebook.react.PackageList;
        import com.facebook.react.ReactApplication;
        import com.facebook.react.ReactNativeHost;
        import com.facebook.react.ReactPackage;
        import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
        import com.facebook.react.defaults.DefaultReactNativeHost;
        import com.facebook.soloader.SoLoader;
        import java.util.List;
        
        public class MainApplication extends Application implements ReactApplication {
        
          private final ReactNativeHost mReactNativeHost =
              new DefaultReactNativeHost(this) {
                @Override
                public boolean getUseDeveloperSupport() {
                  return BuildConfig.DEBUG;
                }
        
                @Override
                protected List<ReactPackage> getPackages() {
                  @SuppressWarnings("UnnecessaryLocalVariable")
                  List<ReactPackage> packages = new PackageList(this).getPackages();
                  return packages;
                }
        
                @Override
                protected String getJSMainModuleName() {
                  return "index";
                }
        
                @Override
                protected boolean isNewArchEnabled() {
                  return BuildConfig.IS_NEW_ARCHITECTURE_ENABLED;
                }
        
                @Override
                protected Boolean isHermesEnabled() {
                  return BuildConfig.IS_HERMES_ENABLED;
                }
              };
        
          @Override
          public ReactNativeHost getReactNativeHost() {
            return mReactNativeHost;
          }
        
          @Override
          public void onCreate() {
            super.onCreate();
            SoLoader.init(this, /* native exopackage */ false);
            if (BuildConfig.IS_NEW_ARCHITECTURE_ENABLED) {
              DefaultNewArchitectureEntryPoint.load();
            }
            ReactNativeFlipper.initializeFlipper(this, getReactNativeHost().getReactInstanceManager());
          }
        }
        EOF
        
        # MainActivity.java
        cat > android/app/src/main/java/com/hyperagent/MainActivity.java << 'EOF'
        package com.hyperagent;
        
        import com.facebook.react.ReactActivity;
        import com.facebook.react.ReactActivityDelegate;
        import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
        import com.facebook.react.defaults.DefaultReactActivityDelegate;
        
        public class MainActivity extends ReactActivity {
        
          @Override
          protected String getMainComponentName() {
            return "HyperAgent";
          }
        
          @Override
          protected ReactActivityDelegate createReactActivityDelegate() {
            return new DefaultReactActivityDelegate(
                this,
                getMainComponentName(),
                DefaultNewArchitectureEntryPoint.getFabricEnabled());
          }
        }
        EOF
        
    - name: Generate debug keystore
      run: |
        cd mobile/android/app
        keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        
    - name: Download Gradle Wrapper
      run: |
        cd mobile/android
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v7.5.1/gradle/wrapper/gradle-wrapper.jar
        
    - name: Make gradlew executable
      run: |
        cd mobile/android
        chmod +x gradlew
        
    - name: Build Debug APK
      run: |
        cd mobile/android
        ./gradlew assembleDebug
        
    - name: Build Release APK (if requested)
      if: github.event.inputs.release == 'true'
      run: |
        cd mobile/android
        ./gradlew assembleRelease
      env:
        MYAPP_UPLOAD_STORE_FILE: ../keystore/release.keystore
        MYAPP_UPLOAD_KEY_ALIAS: release
        MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
        MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: Upload Release APK (if built)
      if: github.event.inputs.release == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: mobile/android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90
        
    - name: Create Release (if requested)
      if: github.event.inputs.release == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.${{ github.run_number }}
        release_name: Hyper AI Agent v1.0.${{ github.run_number }}
        body: |
          ## Release Notes
          - Android APK build
          - Built from commit: ${{ github.sha }}
          - Build date: ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false
